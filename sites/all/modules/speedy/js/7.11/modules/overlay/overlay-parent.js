(function(a){Drupal.behaviors.overlayParent={attach:function(b,c){Drupal.overlay.isOpen&&Drupal.overlay.makeDocumentUntabbable(b);if(this.processed)return;this.processed=!0,a(window).bind("hashchange.drupal-overlay",a.proxy(Drupal.overlay,"eventhandlerOperateByURLFragment")).triggerHandler("hashchange.drupal-overlay"),a(document).bind("click.drupal-overlay mouseup.drupal-overlay",a.proxy(Drupal.overlay,"eventhandlerOverrideLink"))}},Drupal.overlay=Drupal.overlay||{isOpen:!1,isOpening:!1,isClosing:!1,isLoading:!1},Drupal.overlay.prototype={},Drupal.overlay.open=function(b){return this.isOpen||this.isOpening?this.load(b):(this.isOpening=!0,this.originalTitle=document.title,this.create(),this.isOpening=!1,this.isOpen=!0,a(document.documentElement).addClass("overlay-open"),this.makeDocumentUntabbable(),a(document).trigger("drupalOverlayOpen"),this.load(b))},Drupal.overlay.create=function(){this.$container=a(Drupal.theme("overlayContainer")).appendTo(document.body),this.activeFrame=this.$iframeA=a(Drupal.theme("overlayElement")).appendTo(this.$container),this.inactiveFrame=this.$iframeB=a(Drupal.theme("overlayElement")).appendTo(this.$container),this.$iframeA.bind("load.drupal-overlay",{self:this.$iframeA[0],sibling:this.$iframeB},a.proxy(this,"loadChild")),this.$iframeB.bind("load.drupal-overlay",{self:this.$iframeB[0],sibling:this.$iframeA},a.proxy(this,"loadChild"));var b=".drupal-overlay.drupal-overlay-open";a(window).bind("resize"+b,a.proxy(this,"eventhandlerOuterResize")),a(document).bind("drupalOverlayLoad"+b,a.proxy(this,"eventhandlerOuterResize")).bind("drupalOverlayReady"+b+" drupalOverlayClose"+b,a.proxy(this,"eventhandlerSyncURLFragment")).bind("drupalOverlayClose"+b,a.proxy(this,"eventhandlerRefreshPage")).bind("drupalOverlayBeforeClose"+b+" drupalOverlayBeforeLoad"+b+" drupalOverlayResize"+b,a.proxy(this,"eventhandlerDispatchEvent")),a(".overlay-displace-top, .overlay-displace-bottom").length&&a(document).bind("drupalOverlayResize"+b,a.proxy(this,"eventhandlerAlterDisplacedElements")).bind("drupalOverlayClose"+b,a.proxy(this,"eventhandlerRestoreDisplacedElements"))},Drupal.overlay.load=function(b){if(!this.isOpen)return!1;a(document).trigger("drupalOverlayBeforeLoad"),a(document.documentElement).addClass("overlay-loading");var c=this.inactiveFrame[0].contentDocument||this.inactiveFrame[0].contentWindow.document;return c.location.replace(b),!0},Drupal.overlay.close=function(){if(!this.isOpen||this.isClosing)return!1;var b=a.Event("drupalOverlayBeforeClose");return a(document).trigger(b),b.isDefaultPrevented()?!1:(this.isClosing=!0,this.isOpen=!1,a(document.documentElement).removeClass("overlay-open"),document.title=this.originalTitle,this.makeDocumentTabbable(),a(document).trigger("drupalOverlayClose"),this.isLoading||(this.destroy(),this.isClosing=!1),!0)},Drupal.overlay.destroy=function(){a([document,window]).unbind(".drupal-overlay-open"),this.$container.remove(),this.$container=null,this.$iframeA=null,this.$iframeB=null,this.iframeWindow=null},Drupal.overlay.redirect=function(b){var c=a(b.link(b)).get(0);return window.location.href==c.href&&a(window).triggerHandler("hashchange.drupal-overlay"),window.location.href=c.href,!0},Drupal.overlay.bindChild=function(b,c){this.iframeWindow=b;if(c||this.isClosing||!this.isOpen)return;a(document).trigger("drupalOverlayReady")},Drupal.overlay.loadChild=function(b){var c=b.data.self,d=c.contentDocument||c.contentWindow.document,e=d.defaultView||d.parentWindow;if(e.location=="about:blank")return;this.isLoading=!1,a(document.documentElement).removeClass("overlay-loading"),b.data.sibling.removeClass("overlay-active").attr({tabindex:-1});if(this.isOpen&&!this.isClosing)if(e.Drupal&&e.Drupal.overlayChild){document.title=e.document.title,this.activeFrame=a(c).addClass("overlay-active").attr("title",Drupal.t("@title dialog",{"@title":e.jQuery("#overlay-title").text()})).removeAttr("tabindex"),this.inactiveFrame=b.data.sibling,(this.inactiveFrame[0].contentDocument||this.inactiveFrame[0].contentWindow.document).location.replace("about:blank"),this.activeFrame.focus();var f=e.jQuery("a:first");Drupal.overlay.setFocusBefore(f,e.document),a(document).trigger("drupalOverlayLoad")}else window.location=e.location.href.replace(/([?&]?)render=overlay&?/g,"$1").replace(/\?$/,"");else this.destroy()},Drupal.overlay.setFocusBefore=function(b,c){var d=c.createElement("a"),e=a(d).addClass("element-invisible").attr("href","#");e.insertBefore(b),e.focus(),e.one("blur",function(){a(this).remove()})},Drupal.overlay.isAdminLink=function(a){if(Drupal.overlay.isExternalLink(a))return!1;var b=this.getPath(a);if(!this.adminPathRegExp){var c="^"+Drupal.settings.pathPrefix+"(",d=c+Drupal.settings.overlay.paths.admin.replace(/\s+/g,")$|"+c)+")$",e=c+Drupal.settings.overlay.paths.non_admin.replace(/\s+/g,")$|"+c)+")$";d=d.replace(/\*/g,".*"),e=e.replace(/\*/g,".*"),this.adminPathRegExp=new RegExp(d),this.nonAdminPathRegExp=new RegExp(e)}return this.adminPathRegExp.exec(b)&&!this.nonAdminPathRegExp.exec(b)},Drupal.overlay.isExternalLink=function(a){var b=RegExp("^((f|ht)tps?:)?//(?!"+window.location.host+")");return b.test(a)},Drupal.overlay.eventhandlerOuterResize=function(b){if(!this.isOpen&&!this.isOpening||this.isClosing||!this.iframeWindow)return;typeof document.body.style.maxHeight!="string"&&this.activeFrame.height(a(window).height()),a(document).trigger("drupalOverlayResize")},Drupal.overlay.eventhandlerAlterDisplacedElements=function(b){if(!this.isOpen&&!this.isOpening||this.isClosing||!this.iframeWindow)return;a(this.iframeWindow.document.body).css({marginTop:Drupal.overlay.getDisplacement("top"),marginBottom:Drupal.overlay.getDisplacement("bottom")}).addClass("overlay-trigger-reflow").removeClass("overlay-trigger-reflow");var c=this.iframeWindow.document.body.clientHeight,d=this.iframeWindow.document.body.clientWidth,e=typeof document.body.style.maxWidth=="string"?"maxWidth":"width";if(Drupal.overlay.leftSidedScrollbarOffset===undefined&&a(document.documentElement).attr("dir")==="rtl")if(a.browser.opera)Drupal.overlay.leftSidedScrollbarOffset=document.documentElement.clientWidth-this.iframeWindow.document.documentElement.clientWidth+this.iframeWindow.document.documentElement.clientLeft;else if(this.iframeWindow.document.documentElement.clientLeft)Drupal.overlay.leftSidedScrollbarOffset=this.iframeWindow.document.documentElement.clientLeft;else{var f=a('<div style="direction: rtl; overflow: scroll;"></div>').appendTo(document.body),g=a("<div></div>").appendTo(f);Drupal.overlay.leftSidedScrollbarOffset=parseInt(g[0].offsetLeft-f[0].offsetLeft),f.remove()}a(".overlay-displace-top, .overlay-displace-bottom").each(function(){var b=a(this).data(),f=d;this.filters&&this.filters.length&&this.filters.item("DXImageTransform.Microsoft.Shadow")&&(f-=1),Drupal.overlay.leftSidedScrollbarOffset&&a(this).css("left",Drupal.overlay.leftSidedScrollbarOffset);var g=parseInt(a(this).css(e));if(b.drupalOverlay&&b.drupalOverlay.maxWidth||isNaN(g)||g>f||g<=0)a(this).css(e,f),(b.drupalOverlay=b.drupalOverlay||{}).maxWidth=!0;var h=a(this).offset(),i=h.left+a(this).outerWidth();if(b.drupalOverlay&&b.drupalOverlay.clip||i>f)Drupal.overlay.leftSidedScrollbarOffset?a(this).css("clip","rect(auto, auto, "+(c-h.top)+"px, "+(Drupal.overlay.leftSidedScrollbarOffset+2)+"px)"):a(this).css("clip","rect(auto, "+(f-h.left)+"px, "+(c-h.top)+"px, auto)"),(b.drupalOverlay=b.drupalOverlay||{}).clip=!0})},Drupal.overlay.eventhandlerRestoreDisplacedElements=function(b){var c=a(".overlay-displace-top, .overlay-displace-bottom");try{c.css({maxWidth:"",clip:""})}catch(d){c.attr("style",function(a,b){return b.replace(/clip\s*:\s*rect\([^)]+\);?/i,"")})}},Drupal.overlay.eventhandlerOverrideLink=function(b){if(b.type=="click"&&b.button==2||b.type=="mouseup"&&b.button!=2)return;var c=a(b.target);if(!c.is("a")){c=c.closest("a");if(!c.length)return}if(c.hasClass("overlay-exclude"))return;if(c.hasClass("overlay-close")){a.bbq.removeState("overlay");return}var d=c[0],e=d.href;if(e!=undefined&&e!=""&&d.protocol.match(/^https?\:/)){var f=e.replace(d.ownerDocument.location.href,"");if(f.length==0||f.charAt(0)=="#")return;if(this.isAdminLink(e)){var g=c.hasClass("overlay-restore")&&typeof a.bbq.getState("overlay-context")=="string"?Drupal.settings.basePath+a.bbq.getState("overlay-context"):null;e=this.fragmentizeLink(c.get(0),g);if(b.button==0&&!b.altKey&&!b.ctrlKey&&!b.metaKey&&!b.shiftKey)return this.redirect(e),!1;c.one("blur mousedown",{target:d,href:d.href},function(b){a(b.data.target).attr("href",b.data.href)}).attr("href",e)}else if(this.isOpen&&d.ownerDocument===this.iframeWindow.document)if(d.hostname!=window.location.hostname)c.attr("target")||c.attr("target","_parent");else{c.attr("href",a.param.fragment(e,{"overlay-context":this.getPath(window.location)+window.location.search}));var h=a.deparam.querystring(e);if(h.destination&&this.isAdminLink(h.destination)){var i=a.param.fragment(this.getPath(window.location),{overlay:h.destination});c.attr("href",a.param.querystring(e,{destination:i}))}c.attr("target","_parent")}}},Drupal.overlay.eventhandlerOperateByURLFragment=function(b){if(a.data(window.location,window.location.href)==="redirect"){a.data(window.location,window.location.href,null);return}var c=a.bbq.getState("overlay");if(c){var d=a.param.querystring(Drupal.settings.basePath+c,{render:"overlay"});this.open(d),this.resetActiveClass(this.getPath(Drupal.settings.basePath+c))}else this.isOpen&&!this.isClosing&&(this.close(),this.resetActiveClass(this.getPath(window.location)))},Drupal.overlay.eventhandlerSyncURLFragment=function(b){if(this.isOpen){var c=a.bbq.getState("overlay");if(this.getPath(Drupal.settings.basePath+c)!=this.getPath(this.iframeWindow.document.location)){var d=Drupal.overlay.fragmentizeLink(this.iframeWindow.document.location);a.data(window.location,d,"redirect"),window.location.replace(d)}}else a.bbq.removeState("overlay")},Drupal.overlay.eventhandlerRefreshPage=function(a){Drupal.overlay.refreshPage&&window.location.reload(!0)},Drupal.overlay.eventhandlerDispatchEvent=function(a){this.iframeWindow&&this.iframeWindow.document&&this.iframeWindow.jQuery(this.iframeWindow.document).trigger(a)},Drupal.overlay.fragmentizeLink=function(b,c){var d=a.deparam.fragment(b.href);if(d.overlay)return b.href;var e=this.getPath(b,!0),f=e+b.search.replace(/&?render=overlay/,"").replace(/\?$/,"")+b.hash;return a.param.fragment(c||window.location.href,{overlay:f})},Drupal.overlay.refreshRegions=function(b){a.each(b,function(){var b=this;a.each(b,function(c){var d=b[c],e="."+c;Drupal.detachBehaviors(a(e)),a.get(Drupal.settings.basePath+Drupal.settings.overlay.ajaxCallback+"/"+d,function(b){a(e).replaceWith(a(b)),Drupal.attachBehaviors(a(e),Drupal.settings)})})})},Drupal.overlay.resetActiveClass=function(b){var c=this,d=window.location.protocol+window.location.hostname;a(".overlay-displace-top, .overlay-displace-bottom").find("a[href]").removeClass("active").each(function(){var e=this.protocol+this.hostname,f=c.getPath(this);e==d&&(b+"/").indexOf(f+"/")===0&&(f!==""||b==="")&&a(this).addClass("active")})},Drupal.overlay.getPath=function(b,c){typeof b=="string"&&(b=a(b.link(b)).get(0));var d=b.pathname;d.charAt(0)!="/"&&(d="/"+d),d=d.replace(new RegExp(Drupal.settings.basePath+"(?:index.php)?"),"");if(d==""&&!c){var e=(new RegExp("([?&])q=(.+)([&#]|$)")).exec(b.search);e&&e.length==4&&(d=e[2])}return d},Drupal.overlay.getDisplacement=function(b){var c=0,d=a(".overlay-displace-"+b+":last");return d.length&&(c=d.offset().top+d.outerHeight(),d[0].filters&&d[0].filters.length&&d[0].filters.item("DXImageTransform.Microsoft.Shadow")&&(c-=d[0].filters.item("DXImageTransform.Microsoft.Shadow").strength,c=Math.max(0,c))),c},Drupal.overlay.makeDocumentUntabbable=function(b){if(jQuery.browser.msie&&parseInt(jQuery.browser.version,10)<8){a("#overlay-disable-message a",b).attr("tabindex",-1);return}b=b||document.body;var c,d,e;e=a("[tabindex] :not(.overlay-element)",b),e.each(Drupal.overlay._recordTabindex),Drupal.overlay._hasTabindex=e.add(Drupal.overlay._hasTabindex),d=a("a, area, button, input, object, select, textarea, iframe"),d=d.add(e),c=a(".overlay-element, #overlay-container, .overlay-displace-top, .overlay-displace-bottom").find("*"),d=d.not(c),d.attr("tabindex",-1)},Drupal.overlay.makeDocumentTabbable=function(b){if(jQuery.browser.msie&&parseInt(jQuery.browser.version,10)<8)return;var c;b=b||document.body;var d=a("[tabindex]",b);if(jQuery.browser.msie&&parseInt(jQuery.browser.version,10)<8){var e,f=d.length;for(e=0;e<f;e++)d[e].removeAttribute("tabIndex")}else d.removeAttr("tabindex");c=a(Drupal.overlay._hasTabindex,b),c.each(Drupal.overlay._restoreTabindex),Drupal.overlay._hasTabindex=Drupal.overlay._hasTabindex.not(c)},Drupal.overlay._recordTabindex=function(){var b=a(this),c=a(this).attr("tabindex");b.data("drupalOverlayOriginalTabIndex",c)},Drupal.overlay._restoreTabindex=function(){var b=a(this),c=b.data("drupalOverlayOriginalTabIndex");b.attr("tabindex",c)},Drupal.theme.prototype.overlayContainer=function(){return'<div id="overlay-container"><div class="overlay-modal-background"></div></div>'},Drupal.theme.prototype.overlayElement=function(a){return'<iframe class="overlay-element" frameborder="0" scrolling="auto" allowtransparency="true"></iframe>'}})(jQuery);