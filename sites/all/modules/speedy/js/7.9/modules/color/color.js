(function(a){Drupal.behaviors.color={attach:function(b,c){function t(){Drupal.color.callback(b,c,h,m,o,p)}function u(a,b,c){a=m.RGBToHSL(m.unpack(a)),a[0]+=c[0]-b[0];if(b[1]==0||c[1]==0)a[1]=c[1];else{var d=b[1]/c[1];d>1?a[1]/=d:a[1]=1-(1-a[1])*d}if(b[2]==0||c[2]==0)a[2]=c[2];else{var d=b[2]/c[2];d>1?a[2]/=d:a[2]=1-(1-a[2])*d}return m.pack(m.HSLToRGB(a))}function v(b,c,f,g){var h;a(b).css({backgroundColor:c,color:m.RGBToHSL(m.unpack(c))[2]>.5?"#000":"#fff"});if(a(b).val()&&a(b).val()!=c){a(b).val(c);if(f){d=b.i;for(e=d+1;;++e){if(!k[e-1]||a(k[e-1]).is(".unlocked"))break;h=u(c,n[b.key],n[i[e].key]),v(i[e],h,!1)}for(e=d-1;;--e){if(!k[e]||a(k[e]).is(".unlocked"))break;h=u(c,n[b.key],n[i[e].key]),v(i[e],h,!1)}t()}g||w()}}function w(){a("#edit-scheme",h).each(function(){this.selectedIndex=this.options.length-1})}function x(){var b=this;l&&a(l).unbind("keyup",m.updateValue).unbind("keyup",t).unbind("keyup",w).parent().removeClass("item-selected"),l=this,m.linkTo(function(a){v(b,a,!0,!1)}),m.setColor(this.value),a(l).keyup(m.updateValue).keyup(t).keyup(w).parent().addClass("item-selected")}var d,e,f,g,h=a("#system-theme-settings .color-form",b).once("color");if(h.length==0)return;var i=[],j=[],k=[],l=null;a(h).prepend('<div id="placeholder"></div>').addClass("color-processed");var m=a.farbtastic("#placeholder"),n=c.color.reference;for(d in n)n[d]=m.RGBToHSL(m.unpack(n[d]));var o=[],p=[];for(d in c.gradients){a("#preview").once("color").append('<div id="gradient-'+d+'"></div>');var q=a("#preview #gradient-"+d);o.push(parseInt(q.css("height"),10)/10),p.push(parseInt(q.css("width"),10)/10);for(e=0;e<(c.gradients[d]["direction"]=="vertical"?o[d]:p[d]);++e)q.append('<div class="gradient-line"></div>')}if(navigator.appVersion.match(/MSIE [0-6]\./)){var r=a("#preview #img")[0],s=r.currentStyle.backgroundImage;r.style.backgroundImage="none",r.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled=true, sizingMethod=crop, src='"+s.substring(5,s.length-2)+"')"}a("#edit-scheme",h).change(function(){var b=c.color.schemes,d=this.options[this.selectedIndex].value;if(d!=""&&b[d]){f=b[d];for(g in f)v(a("#edit-palette-"+g),f[g],!1,!0);t()}}),a("#palette input.form-text",h).each(function(){this.key=this.id.substring(13),m.linkTo(function(){}).setColor("#000").linkTo(this);var b=i.length;if(i.length){var c=a('<div class="lock"></div>').toggle(function(){a(this).addClass("unlocked"),a(j[b-1]).attr("class",k[b-2]&&a(k[b-2]).is(":not(.unlocked)")?"hook up":"hook"),a(j[b]).attr("class",k[b]&&a(k[b]).is(":not(.unlocked)")?"hook down":"hook")},function(){a(this).removeClass("unlocked"),a(j[b-1]).attr("class",k[b-2]&&a(k[b-2]).is(":not(.unlocked)")?"hook both":"hook down"),a(j[b]).attr("class",k[b]&&a(k[b]).is(":not(.unlocked)")?"hook both":"hook up")});a(this).after(c),k.push(c)}var d=a('<div class="hook"></div>');a(this).after(d),j.push(d),a(this).parent().find(".lock").click(),this.i=b,i.push(this)}).focus(x),a("#palette label",h),x.call(i[0]),t()}}})(jQuery);